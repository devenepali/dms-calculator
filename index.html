<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>水準測量</title>
  <style>
    :root{
      --bd:#d0d7de;
      --bg:#ffffff;
      --bg2:#f6f8fa;
      --sum:#fff8c5;
      --txt:#24292f;
      --muted:#57606a;
      --radius:10px;
    }

    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      margin: 12px;
      color: var(--txt);
      background: var(--bg);
      -webkit-text-size-adjust: 100%;
    }

    h1{ margin:0 0 10px; font-size: 18px; }
    .note{ color:var(--muted); font-size: 12px; line-height: 1.5; margin-bottom: 10px; }

    /* Fit to screen, no horizontal scroll */
    .wrap{
      overflow: visible;
      border:1px solid var(--bd);
      border-radius: var(--radius);
      max-width: 100%;
    }

    table{
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
      background: var(--bg);
    }

    thead th{
      position: sticky;
      top: 0;
      z-index: 3;
      background: var(--bg2);
      border:1px solid var(--bd);
      padding: 8px 4px;
      text-align:center;
      font-weight:700;
      font-size: 12px;
      white-space: nowrap;
    }
    thead tr:nth-child(2) th{
      top: 38px;
      z-index: 3;
    }

    tbody td, tfoot td{
      border:1px solid var(--bd);
      padding: 4px;
      text-align:center;
      font-size: 12px;
      white-space: nowrap;
    }

    input{
      width: 100%;
      box-sizing: border-box;
      padding: 6px 2px;
      border: 1px solid var(--bd);
      border-radius: 8px;
      font-size: 13px;
      text-align: center;
      background: #fff;
      min-height: 36px;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0;
    }

    /* readonly result cells */
    input[readonly]{
      background:#fbfbfb;
      color:#111;
      font-size: 13px; /* keep readable */
      padding: 6px 2px;
    }

    /* Make specific columns smaller to free space */
    .col-no input{ font-size: 11px; padding: 6px 1px; }
    .col-dist input{ font-size: 11px; padding: 6px 1px; }

    /* Make +/- result columns bigger and prevent clipping */
    .col-plus input[readonly],
    .col-minus input[readonly]{
      font-size: 14px;      /* slightly larger */
      padding: 6px 1px;
      text-overflow: clip;
    }

    tfoot td{
      position: sticky;
      bottom: 0;
      z-index: 2;
      background: var(--sum);
      font-weight: 700;
    }
    tfoot input{ font-weight: 700; }

    .btns{
      display:flex;
      gap:10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    button{
      border:1px solid var(--bd);
      background: var(--bg2);
      padding: 10px 12px;
      border-radius: 10px;
      cursor:pointer;
      font-size: 14px;
      min-height: 44px;
    }

    /* Column widths: prioritize 高低差 (+/-) */
    /* Total = 100% */
    th:nth-child(1), td:nth-child(1){ width: 8%; }   /* 番号 (smaller) */
    th:nth-child(2), td:nth-child(2){ width: 12%; }  /* 距離 (smaller) */
    th:nth-child(3), td:nth-child(3){ width: 16%; }  /* 後視 */
    th:nth-child(4), td:nth-child(4){ width: 16%; }  /* 前視 */
    th:nth-child(5), td:nth-child(5){ width: 24%; }  /* 高低差 + (bigger) */
    th:nth-child(6), td:nth-child(6){ width: 24%; }  /* 高低差 - (bigger) */

    /* Very small phones */
    @media (max-width: 360px){
      thead th{ font-size: 11px; padding: 6px 2px; }
      input{ font-size: 12px; min-height: 34px; }
      .col-no input, .col-dist input{ font-size: 10px; }
      .col-plus input[readonly], .col-minus input[readonly]{ font-size: 13px; }
    }
  </style>
</head>
<body>
  <h1>水準測量（27行 + 合計行）</h1>
  <div class="note">
    計算: <b>Δ = 後視 − 前視</b><br/>
    Δ &gt; 0 → 高低差(＋) に <b>|Δ|</b>、Δ &lt; 0 → 高低差(－) に <b>|Δ|</b>（常に正の値で表示）
  </div>

  <div class="wrap">
    <table>
      <thead>
        <tr>
          <th rowspan="2">番号</th>
          <th rowspan="2">距離</th>
          <th rowspan="2">後視</th>
          <th rowspan="2">前視</th>
          <th colspan="2">高低差</th>
        </tr>
        <tr>
          <th>＋</th>
          <th>－</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
      <tfoot>
        <tr>
          <td>合計</td>
          <td><input id="sum_dist" readonly></td>
          <td><input id="sum_bs" readonly></td>
          <td><input id="sum_fs" readonly></td>
          <td><input id="sum_plus" readonly></td>
          <td><input id="sum_minus" readonly></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="btns">
    <button id="fillNoBtn" type="button">番号を1〜27で自動入力</button>
    <button id="clearBtn" type="button">全クリア</button>
  </div>

  <script>
    const N = 27;

    function toHalfWidth(str){
      return (str ?? "")
        .toString()
        .replace(/[０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0))
        .replace(/．/g, ".")
        .replace(/－/g, "-")
        .replace(/，/g, ",")
        .trim();
    }

    function parseNum(v){
      const t = toHalfWidth(v);
      if (t === "") return null;
      const n = Number(t.replace(/,/g,""));
      return Number.isFinite(n) ? n : null;
    }

    // Always show exactly 3 decimals
    function fmt(x){
      if (x === null) return "";
      return (Math.round(x * 1000) / 1000).toFixed(3);
    }

    const body = document.getElementById("body");

    function makeCellInput(id, readonly=false){
      const td = document.createElement("td");
      const inp = document.createElement("input");
      inp.id = id;
      inp.autocomplete = "off";
      inp.spellcheck = false;
      inp.inputMode = "decimal";
      inp.type = "text";
      if (readonly) inp.readOnly = true;
      td.appendChild(inp);
      return td;
    }

    function build(){
      for (let i=1;i<=N;i++){
        const tr = document.createElement("tr");

        const tdNo   = makeCellInput(`no_${i}`);
        const tdDist = makeCellInput(`dist_${i}`);
        const tdBs   = makeCellInput(`bs_${i}`);   // 後視
        const tdFs   = makeCellInput(`fs_${i}`);   // 前視
        const tdPlus = makeCellInput(`plus_${i}`, true);
        const tdMinus= makeCellInput(`minus_${i}`, true);

        tdNo.classList.add("col-no");
        tdDist.classList.add("col-dist");
        tdPlus.classList.add("col-plus");
        tdMinus.classList.add("col-minus");

        tr.appendChild(tdNo);
        tr.appendChild(tdDist);
        tr.appendChild(tdBs);
        tr.appendChild(tdFs);
        tr.appendChild(tdPlus);
        tr.appendChild(tdMinus);

        body.appendChild(tr);

        ["dist_", "bs_", "fs_"].forEach(p=>{
          document.getElementById(`${p}${i}`).addEventListener("input", ()=>{
            calcRow(i);
            calcSums();
          });
        });
      }
      calcSums();
    }

    function calcRow(i){
      const bs = parseNum(document.getElementById(`bs_${i}`).value); // 後視
      const fs = parseNum(document.getElementById(`fs_${i}`).value); // 前視
      const plusEl  = document.getElementById(`plus_${i}`);
      const minusEl = document.getElementById(`minus_${i}`);

      plusEl.value = "";
      minusEl.value = "";

      if (bs === null || fs === null) return;

      const d = bs - fs;      // Δ = 後視 - 前視
      const a = Math.abs(d);  // show positive value

      if (d > 0) plusEl.value = fmt(a);
      else if (d < 0) minusEl.value = fmt(a);
    }

    function sumCol(prefix){
      let s = 0;
      let any = false;
      for (let i=1;i<=N;i++){
        const v = parseNum(document.getElementById(`${prefix}${i}`).value);
        if (v !== null){ s += v; any = true; }
      }
      return any ? s : null;
    }

    function calcSums(){
      document.getElementById("sum_dist").value  = fmt(sumCol("dist_"));
      document.getElementById("sum_bs").value    = fmt(sumCol("bs_"));
      document.getElementById("sum_fs").value    = fmt(sumCol("fs_"));
      document.getElementById("sum_plus").value  = fmt(sumCol("plus_"));
      document.getElementById("sum_minus").value = fmt(sumCol("minus_"));
    }

    document.getElementById("fillNoBtn").addEventListener("click", ()=>{
      for (let i=1;i<=N;i++) document.getElementById(`no_${i}`).value = i;
    });

    document.getElementById("clearBtn").addEventListener("click", ()=>{
      for (let i=1;i<=N;i++){
        ["no_","dist_","bs_","fs_","plus_","minus_"].forEach(p=>{
          document.getElementById(`${p}${i}`).value = "";
        });
      }
      calcSums();
    });

    build();
  </script>
</body>
</html>
